@page
@model Web0524.Pages.OrdersetAddModel
<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.min.js" integrity="sha384-Rx+T1VzGupg4BHQYs2gCW9It+akI2MM/mndMCy36UVfodzcJcF0GGLxZIzObiEfa" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="~/css/Share.css">
    <link rel="stylesheet" href="~/css/wickedcss.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* 添加样式以控制模态框的显示 */
        .modal {
            display: none;
            position: fixed;
            z-index: 3000; /* 调高 z-index 值 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            text-align: center;
        }

        .modal-button {
            margin: 10px;
        }
    </style>
    <style>
        .card {
        }

        .card-body {
            overflow: auto; /* 超出高度時顯示捲軸 */
        }
    </style>
    <style>
        .container {
            padding: 20px;
        }

        .card {
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s ease;
        }

            .card:hover {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            .card img {
                width: auto; /* 設定圖片寬度為自動計算，根據原有的長寬比例 */
                height: 100%; /* 讓圖片的高度佔滿整個卡片 */
                object-fit: cover; /* 使用 object-fit 屬性，讓圖片等比例填滿圖片容器 */
                border-top-left-radius: 8px;
                border-top-right-radius: 8px;
                border-bottom-left-radius: 8px;
                border-bottom-right-radius: 8px; 
            }

        .card-body {
            padding: 15px;
        }

        .card-title {
            color: var(--color3);
            font-size: 20px;
            margin-bottom: 10px;
        }

        .card-text {
            color: var(--color3_2);
            font-size: 16px;
            margin-bottom: 5px;
        }

        .card-footer {
            padding: 10px 15px;
            text-align: right;
        }

    </style>

    <style>
        /* ... 其他樣式 ... */
        .shadow-box {
            box-shadow: 10px 10px 15px #ebd5bf, -10px -10px 15px #fff9e1;
        }
        /* 新增樣式 */
        .hot-label {
            position: absolute;
            top: 20px;
            left: 25px;
            background-color: red;
            color: white;
            padding: 5px;
            border-radius: 5px;
        }
        /* 新上市標籤樣式 */
        .new-label {
            position: absolute;
            top: 20px;
            left: 25px;
            background-color: #00cc66;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
        }
        /* 打折標籤樣式 */
        .discount-label {
            position: absolute;
            top: 20px;
            left: 25px;
            background-color: #ffcc00;
            color: black;
            padding: 4px 8px;
            border-radius: 4px;
        }
    </style>

</head>
<body>
    <div class="page-basetop">
        <header>
            <div class="animation-div">
                <h2 class="header_text heading break-all slideDown">
                    綁定Line帳號，收取預約通知
                </h2>
            </div>
        </header>

        <form method="post" id="order">
            @Html.AntiForgeryToken()
            <div class="form-group" style="display: none;">
                <input asp-for="Orderset.Pid" class="form-control" readonly />
                <span class="text-danger"></span>
            </div>
            <div class="form-group" style="display: none;">
                <input asp-for="Orderset.Pname" class="form-control" readonly />
                <span class="text-danger"></span>
            </div>
            <div class="form-group" style="display: none;">
                <input asp-for="Orderset.Price" class="form-control" readonly />
                <span class="text-danger"></span>
            </div>
            <div class="form-group" style="display: none;">
                <label>產品單位</label>
                <input asp-for="Orderset.Unit" class="form-control" readonly />
                <span class="text-danger"></span>
            </div>



            <div class="container">
                <div class="row">
                    <!-- 左邊顯示圖片 -->
                    <div class="col-md-4">
                        <div class="card mb-3  shadow-box animate__animated animate__fadeInLeft">
                            @{
                                string imageData = Model.Orderset.Photo != null ? Convert.ToBase64String(Model.Orderset.Photo) : null;
                            }
                            @if (string.IsNullOrEmpty(imageData))
                            {
                                <img src="dist/img/product.jpg" class="card-img-top" alt="圖片">
                            }
                            else
                            {
                                <img src="data:image/jpeg;base64,@imageData" class="card-img-top" alt="圖片">
                            }
                            @{
                                string price = Model.Orderset.Price != null ? Model.Orderset.Price.ToString() : "無";
                            }

                            <!-- 新增 HOT 標籤的判斷 -->
                            @if (Model.Product.Event == 1)
                            {
                                <div class="hot-label">
                                    <i class="fab fa-hotjar"></i>
                                    Hot熱門
                                </div>
                            }
                            else if (Model.Product.Event == 2)
                            {
                                <div class="new-label">
                                    <i class="fas fa-flag"></i>
                                    New新上市
                                </div>
                            }
                            else if (Model.Product.Event == 3)
                            {
                                <div class="discount-label">
                                    <i class="fas fa-tags"></i>
                                    優惠中
                                </div>
                            }

                        </div>
                    </div>
                    <!-- 右邊有上下兩籃 -->
                    <div class="col-md-8 d-flex flex-column ">
                        <!-- 上籃顯示產品相關資訊 -->
                        <div class="card mb-3 flex-grow-1 animate__animated animate__fadeInUpBig shadow-box">
                            <div class="card-body">
                                <h3 class="card-title">@Model.Orderset.Pname</h3>
                                </br>
                                <p>
                                    <div class="animate__animated animate__zoomIn" style="color: var(--color3_2);">
                                        <p style="white-space: pre-wrap;">@Model.Product.Content</p>
                                    </div>
                                </p>
                                <p class="card-text"><i class="fas fa-coins"></i>&nbsp;&nbsp;@price&nbsp;&nbsp;/&nbsp;&nbsp;@Model.Orderset.Unit</p>
                            </div>
                        </div>
                        <!-- 下籃顯示預約日期、時間以及新增預約按鈕 -->

                                <div class="form-group alert alert-light alert-form-div mb-3 animate__animated animate__fadeInUpBig shadow-box" role="alert">
                                    <table style="width:100%;">
                                        <tr>
                                            <th>
                                                <label class="card-title">選擇預約日期</label>
                                            </th>
                                            <td>
                                                <input asp-for="Orderset.Date" class="form-control" type="date"
                                                       min="@(((DateTime)ViewData["taipeiTime"]).AddDays(0).ToString("yyyy-MM-dd"))"
                                                       max="@(((DateTime)ViewData["taipeiTime"]).AddMonths(2).ToString("yyyy-MM-dd"))" required/>
                                            </td>
                                        </tr>
                                         <tr>
                                            <th>
                                                <label class="card-title">選擇預約時間</label>
                                            </th>
                                            <td>

                                        <select asp-for="Orderset.Time" class="form-control" id="timePicker" required>
                                                    <option value="09:00">09:00</option>
                                                    <option value="09:30">09:30</option>
                                                    <option value="10:00">10:00</option>
                                                    <option value="10:30">10:30</option>
                                                    <option value="11:00">11:00</option>
                                                    <option value="11:30">11:30</option>
                                                    <option value="12:00">12:00</option>
                                                    <option value="12:30">12:30</option>
                                                    <option value="13:00">13:00</option>
                                                    <option value="13:30">13:30</option>
                                                    <option value="14:00">14:00</option>
                                                    <option value="14:30">14:30</option>
                                                    <option value="15:00">15:00</option>
                                                    <option value="15:30">15:30</option>
                                                    <option value="16:00">16:00</option>
                                                    <option value="16:30">16:30</option>
                                                    <option value="17:00">17:00</option>
                                                    <option value="17:30">17:30</option>
                                                    <option value="18:00">18:00</option>
                                                    <option value="18:30">18:30</option>
                                                    <option value="19:00">19:00</option>
                                                    <option value="19:30">19:30</option>
                                                    <option value="20:00">20:00</option>
                                                    <option value="20:30">20:30</option>
                                                    <option value="21:00">21:00</option>
                                                    <option value="21:30">21:30</option>
                                                    <option value="22:00">22:00</option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <th>
                                                <label class="card-title">選擇場所</label>
                                            </th>
                                            <td>
                                        <select asp-for="Orderset.Placeid" class="form-control" required>
                                                    <option value="">請選擇場所</option>
                                                    @foreach (var place in Model.Place)
                                                    {
                                                        <option value="@place.Placeid">@place.Placetitle</option>
                                                    }
                                                </select>
                                            </td>
                                        </tr>

                                        @if (Model.User_me != null && int.Parse(Model.User_me.UserType) <= 2)
                                        {
                                            <tr>
                                                <th>
                                                    <label class="card-title">預約會員</label>
                                                </th>
                                                <td>
                                                    <input id="userSearchInput" class="form-control" type="text" placeholder="輸入會員名稱或ID快速搜索" />
                                            <select id="OrderUserSelect" name="OrderUser" class="form-control">
                                                <option value="">請選擇預約會員</option>
                                                @foreach (var user in Model.users)
                                                {
                                                    <option value="@user.Id" data-line="@user.LineUserId">@user.Name</option>
                                                }
                                            </select>
                                                </td>
                                            </tr>
                                        }
                                    </table>

                                    <br>
                                    @if (Model.User_me != null && int.Parse(Model.User_me.UserType) <= 2)
                                    {
                                        <div class="d-flex justify-content-end">
                                            <button id="submitButton1" type="button" class="btn btn-dark" onclick="getUserLine(true,''); usercheck()">立即預約</button>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-content-end">
                                            <button id="submitButton1" type="button" class="btn btn-dark" onclick="getUserLine(false,'@Model.User_me.LineUserId'); usercheck()">立即預約</button>
                                        </div>
                                    }

                                </div>

                    </div>
                </div>
            </div>

        </form>

@*        <div id="myModal" class="modal">
            <div class="modal-content">
                <p>您尚未綁定Line，您將無法收到最新訊息、優惠活動以及預約相關的通知。？</p>
                @if (Model.User_me != null && int.Parse(Model.User_me.UserType) <= 2)
                {
                    <button class="modal-button btn btn-primary" onclick="getUserid(true, ''); bindNow()">立即綁定</button>
                }
                else
                {
                    <button class="modal-button btn btn-primary" onclick="getUserid(false,'@Model.User_me.Id'); bindNow()">立即綁定</button>
                }
                <button id="submitButton2" class="modal-button btn btn-dark" onclick="continueAnyway()">仍要繼續</button>
                <button class="modal-button btn btn-light" onclick="cancelAction()">取消</button>
            </div>
        </div>*@
        <div id="myModal" class="modal">
            <div class="modal-content">
                <p>親愛的！預約訂單提交後，須等待預約成功簡訊確認完成預約。謝謝您。</p>
                <button id="submitButton2" class="modal-button btn btn-dark" onclick="continueAnyway()">了解，我會等待簡訊</button>
                <button class="modal-button btn btn-light" onclick="cancelAction()">稍後再提交</button>
            </div>
        </div>
        <script>
            var userLine = "";
            var userId="";
            function getUserLine(opselect, userline) {
                if (opselect) {
                    var selectElement = document.querySelector('select[name="OrderUser"]');
                    var selectedOption = selectElement.options[selectElement.selectedIndex];
                    userLine = selectedOption.getAttribute("data-line");
                } else {
                    userLine = userline;
                }
            }
            function getUserid(opselect, userid) {
                if (opselect) {
                    
                    var selectElement = document.querySelector('select[name="OrderUser"]');
                    var selectedOption = selectElement.options[selectElement.selectedIndex];
                    userId = selectedOption.value;
                    console.log("123"+userId);
                } else {
                    userId = userid;
                    console.log("456" + userId);
                }
            }
            //function usercheck() {
            //    document.getElementById("submitButton1").disabled = true;
            //    document.getElementById("submitButton1").innerText = "請稍後...";
            //    var modal = document.getElementById("myModal");
            //    if (userLine == null || userLine == "") {
            //        modal.style.display = "block";
            //    } else {
            //        // 获取表单元素并提交
            //        var form = document.getElementById("order"); // 将 "yourFormId" 替换为实际的表单 ID
            //        form.submit();
            //    }
            //}
            function usercheck() {
                var form = document.getElementById("order"); // 将 "yourFormId" 替换为实际的表单 ID
                var requiredFields = form.querySelectorAll('[required]'); // 获取所有必填字段
                var allFieldsValid = true;
                // 检查必填字段是否都已填写
                requiredFields.forEach(function (field) {
                    if (field.value.trim() === '') {
                        allFieldsValid = false;
                    }
                });

                if (allFieldsValid) {
                    // 所有必填字段都已填写，禁用提交按钮，然后提交表单
                    document.getElementById("submitButton1").disabled = true;
                    document.getElementById("submitButton1").innerText = "請稍後...";
                    var modal = document.getElementById("myModal");
                    modal.style.display = "block";
                }else{
                    alert("請填寫所有預約資料.");
                }

            }
            //function bindNow() {
            //    var redirectUrl = "UserEdit?id=" + userId;
            //    // 执行页面跳转
            //    window.location.href = redirectUrl;
            //}
            function continueAnyway() {
                var form = document.getElementById("order"); // 将 "yourFormId" 替换为实际的表单 ID
                var requiredFields = form.querySelectorAll('[required]'); // 获取所有必填字段
                var allFieldsValid = true;

                // 检查必填字段是否都已填写
                requiredFields.forEach(function (field) {
                    if (field.value.trim() === '') {
                        allFieldsValid = false;
                    }
                });

                if (allFieldsValid) {
                    // 所有必填字段都已填写，禁用提交按钮，然后提交表单
                    document.getElementById("submitButton2").disabled = true;
                    document.getElementById("submitButton2").innerText = "請稍後...";
                    form.submit();
                } else {
                    alert("請填寫所有預約資料.");
                }
            }
            //function cancelAction() {
            //    var modal = document.getElementById("myModal");
            //    modal.style.display = "none";
            //    document.getElementById("submitButton1").disabled = false;
            //    document.getElementById("submitButton1").innerText = "立即預約";
            //    document.getElementById("submitButton2").disabled = false;
            //    document.getElementById("submitButton2").innerText = "仍要繼續";
            //}
            function cancelAction() {
                var modal = document.getElementById("myModal");
                modal.style.display = "none";
                document.getElementById("submitButton1").disabled = false;
                document.getElementById("submitButton1").innerText = "立即預約";
                document.getElementById("submitButton2").disabled = false;
                document.getElementById("submitButton2").innerText = "了解，我會等待簡訊";
            }
        </script>
    </div>
    
</body>
</html>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchInput = document.getElementById("userSearchInput");
        const selectElement = document.getElementById("OrderUserSelect");
        const originalOptions = Array.from(selectElement.options); // 保存原始选项

        searchInput.addEventListener("input", function () {
            const keyword = searchInput.value.trim().toLowerCase();
            const filteredOptions = originalOptions.filter(option => {
                const text = option.textContent.toLowerCase();
                const value = option.value.toLowerCase();
                return text.includes(keyword) || value.includes(keyword);
            });

            // 清空旧的选项
            selectElement.innerHTML = '';

            // 添加新选项
            selectElement.appendChild(new Option("請選擇預約會員", ""));
            filteredOptions.forEach(option => {
                selectElement.appendChild(option.cloneNode(true));
            });
        });
    });
</script>